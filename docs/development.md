# Development Documentation

## Service Manager API
This service broker was in part generated by the [swagger-codegen](https://github.com/swagger-api/swagger-codegen) project. By using the [OpenAPI-Spec](https://github.com/swagger-api/swagger-core/wiki) from a remote server, you can easily generate a server stub. Using the swagger specification for this broker, you can also generate a client to interact with the broker, should `curl` not be your preference. The implementation uses the [Connexion](https://github.com/zalando/connexion) library on top of Flask and requires Python 3.6. To use Python 3.5 you will need the `typing` module dependency, but this is included in the `requirements.txt` file. Python 2.x is not supported.

See `./gen_api_skels.sh` on how the command line is to generate the code.

The ESM uses the [Connexion](https://github.com/zalando/connexion) library on top of Flask.

To run the ESM, please execute the following from the root directory:

```
virtualenv .env
source .env/bin/activate
pip3 install -r requirements.txt
python3 ./runesm.py
```

If you want to view the Swagger UI you can simply navigate to this URL in your browser:
```
http://localhost:8080/ui/
```

To retrieve the swagger specification of the running ESM simply use `curl` or `wget` against this URL
```
http://localhost:8080/swagger.json
```

To launch the integration tests, use tox:
```
pip install tox
tox
```
## Running Tests

```shell
sudo pip install tox docker-tox
tox
```

Ensure that you run from a virtual environments:

```shell
virtualenv .env
source .env/bin/activate
```

To launch the tests, use tox. Ensure the test requirements are installed:

`pip install -r test-requirements.txt`

From the root of the project you can run all tests with:

```
sudo pip install tox
tox
```

By default, the mongodb backend is enabled in tox. If you want to change this or if the Docker tests are run edit the variables `MONGODB_TESTS` and/or `DOCKER_TESTS` in `tox.ini`.

If you don't want to run and use `nosetests` you can easily do so. To enable/disable the Mongo or Docker tests simply set the shell variables of `MONGODB_TESTS` and/or `DOCKER_TESTS` to `YES` or `NO`.

To interact with the API after running `runsm.py`, you can use the [Postman](https://www.getpostman.com) collection that's under `tests/postman`.

You can see the [current test coverage here](https://codecov.io/gh/elastest/elastest-service-manager).


## Extending

### Data Store

Subclass `adapters.datastore.Store` and implement for you persistence system.

Currently supported:

* `adapters.datastore.InMemoryStore`: this is a datastore driver that holds all ESM state in memory. To be used for testing only as restarting the ESM process will destroy all recorded information.


* `adapters.datastore.MongoDB`: this is a datastore driver that persists all ESM state into mongodb. Data is kept across reboots of the ESM process.

### Resource Manager

Subclass `adapters.resources.Backend` and implement for you persistence system. You will then have to register your Backend driver with the `adapters.resources.ResourceManager` class.

Currently supported:

* `adapters.resources.DummyBackend`: This is a NoOp driver used for speedy testing.


* `adapters.resources.DockerBackend`: Uses a docker-compose file to deploy the service software. This can point not only to a local docker deployment (not distributed), but also to a docker swarm.

## Building with Docker

There is a docker build file `./Dockerfile` in the root of this project. You can use this to create a docker image that can then be ran upon your local docker environment.

### To Build Locally

```shell
docker build -t elastest/elastest-service-manager:latest ./
```

## Running the ESM Outside of a Virtualisation Technology

Ensure you have all dependencies required: `pip3 install -r requirements.txt`

Configure the following OS environment variables:

* `ESM_PORT`: this is the port under which the service broker runs. By default it runs on `8080`.
* `ESM_CHECK_PORT`: this is the port where health checks are served. By default it runs on `5000`.
* `ESM_MONGO_HOST`: this is the host where a mongodb service is running. It is used to persist ESM state. If it's not set then an in-memory store is used.

Example config and run:

```shell
$ export ESM_PORT=9999
$ export ESM_CHECK_PORT=8888
$ export ESM_MONGO_HOST=localhost
$ python ./runesm.py
2017-07-26 11:37:22,918 [58778] INFO     adapters.datasource: Using the MongoDBStore.
2017-07-26 11:37:22,918 [58778] INFO     adapters.datasource: MongoDBStore is persistent.
2017-07-26 11:37:23,382 [58778] INFO     adapters.resources: Adding docker-compose alias to DockerBackend
2017-07-26 11:37:23,382 [58778] INFO     adapters.resources: Adding k8s alias to KubernetesBackend
2017-07-26 11:37:23,389 [58778] INFO     __main__: OSBA API and ElasTest extensions API created.
2017-07-26 11:37:23,390 [58778] INFO     __main__: ESM available at http://0.0.0.0:9999
2017-07-26 11:37:23,390 [58778] INFO     __main__: ESM Health available at http://0.0.0.0:8888
2017-07-26 11:37:23,390 [58778] INFO     __main__: Press CTRL+C to quit.
```

The service manager endpoint should only be the scheme (http or https) and the fully qualified host name, optionally including the port number if it differs from the standard port 80 or 443.


## Notes

To build the swagger-codegen [tool yourself](https://github.com/swagger-api/swagger-codegen/tree/master#building)

``` sh
# server files
# assumes a brew installation of swagger code gen
SWAGGER_CODE_GEN="/usr/local/bin/swagger-codegen"
$SWAGGER_CODE_GEN generate -i  ./api.yaml -l python-flask -o ./ -DpackageName=esm --import-mappings object=#

# client files
$SWAGGER_CODE_GEN generate -i  ./apidef/swagger/open_service_broker_api.yaml -l python -o ./client -DpackageName=esm-client
```
